# Plan 3: Admin User Management

⚠️ **Complexity: Medium** - Multiple components, requires careful coordination between backend and frontend

## Overview
Enable admins to create users and disable public sign-up. Users will only be able to sign in with credentials created by an admin.

## Goals
1. ✅ Admin API endpoint to create users with email/password
2. ✅ Modify AuthForm to remove sign-up toggle (sign-in only)
3. ✅ Admin UI page for user management (create users, view user list)
4. ✅ Database schema to track user profiles with admin status
5. ✅ Update admin detection from hardcoded email to database field

## Current State
- Admin detection: Hardcoded check for `creator@rag.com` in `dependencies.py:45`
- AuthForm: Allows toggling between sign-in and sign-up (`AuthForm.tsx:8-106`)
- No user_profiles table yet (TODO comment exists in dependencies.py:43)

## Implementation Plan

### Phase 1: Database Schema - User Profiles Table
**Files:** `supabase/migrations/YYYYMMDDHHMMSS_add_user_profiles.sql`

Create `user_profiles` table to store admin status and other user metadata:

```sql
-- Create user_profiles table
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  is_admin BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID REFERENCES auth.users(id)
);

-- Enable RLS
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Policy: Users can read their own profile
CREATE POLICY "Users can view own profile"
  ON user_profiles
  FOR SELECT
  USING (auth.uid() = id);

-- Policy: Admins can read all profiles
CREATE POLICY "Admins can view all profiles"
  ON user_profiles
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND is_admin = true
    )
  );

-- Policy: Admins can insert new profiles (when creating users)
CREATE POLICY "Admins can create profiles"
  ON user_profiles
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND is_admin = true
    )
  );

-- Create function to auto-create profile on user signup (for existing users)
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO user_profiles (id, email, is_admin)
  VALUES (NEW.id, NEW.email, false)
  ON CONFLICT (id) DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger for new auth.users
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION handle_new_user();

-- Create admin user manually (creator@rag.com)
-- Note: This should be done via Supabase dashboard or a one-time migration
-- INSERT INTO user_profiles (id, email, is_admin)
-- SELECT id, email, true FROM auth.users WHERE email = 'creator@rag.com'
-- ON CONFLICT (id) DO UPDATE SET is_admin = true;
```

**Validation:**
```bash
# Apply migration
supabase db push

# Verify table exists
supabase db psql -c "SELECT * FROM user_profiles LIMIT 5;"

# Verify admin user exists
supabase db psql -c "SELECT email, is_admin FROM user_profiles WHERE email = 'creator@rag.com';"
```

### Phase 2: Backend - Admin User Creation Endpoint
**Files:**
- `backend/app/routers/admin.py` (new)
- `backend/app/main.py` (update to include router)
- `backend/app/dependencies.py` (update to query user_profiles)

#### 2.1: Update dependencies.py to use user_profiles table
```python
async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> User:
    """Verify Supabase JWT token and extract user info, including admin status."""
    settings = get_settings()
    token = credentials.credentials
    supabase = get_supabase_client()

    try:
        payload = jwt.decode(
            token,
            settings.supabase_anon_key,
            algorithms=["HS256", "ES256"],
            options={"verify_signature": False},
            audience="authenticated"
        )

        user_id = payload.get("sub")
        email = payload.get("email")

        if not user_id:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid token: missing user ID"
            )

        # Query user_profiles for admin status
        response = supabase.table("user_profiles").select("is_admin").eq("id", user_id).single().execute()

        is_admin = response.data.get("is_admin", False) if response.data else False

        return User(id=user_id, email=email, is_admin=is_admin)

    except JWTError as e:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=f"Invalid token: {str(e)}"
        )
```

#### 2.2: Create admin router with user creation endpoint
```python
# backend/app/routers/admin.py
from fastapi import APIRouter, Depends, HTTPException, status
from pydantic import BaseModel, EmailStr
from app.dependencies import get_admin_user, User
from app.db.supabase import get_supabase_admin_client
from app.config import get_settings

router = APIRouter(prefix="/admin", tags=["admin"])


class CreateUserRequest(BaseModel):
    email: EmailStr
    password: str
    is_admin: bool = False


class UserResponse(BaseModel):
    id: str
    email: str
    is_admin: bool
    created_at: str


@router.post("/users", response_model=UserResponse, status_code=status.HTTP_201_CREATED)
async def create_user(
    request: CreateUserRequest,
    admin: User = Depends(get_admin_user)
) -> UserResponse:
    """Create a new user (admin only). Uses Supabase Admin API."""
    supabase_admin = get_supabase_admin_client()

    try:
        # Create user in auth.users via Admin API
        auth_response = supabase_admin.auth.admin.create_user({
            "email": request.email,
            "password": request.password,
            "email_confirm": True  # Auto-confirm email
        })

        if not auth_response.user:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="Failed to create user in auth system"
            )

        user_id = auth_response.user.id

        # Create user profile
        profile_data = {
            "id": user_id,
            "email": request.email,
            "is_admin": request.is_admin,
            "created_by": admin.id
        }

        profile_response = supabase_admin.table("user_profiles").insert(profile_data).execute()

        if not profile_response.data:
            # Rollback: delete auth user if profile creation fails
            supabase_admin.auth.admin.delete_user(user_id)
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="Failed to create user profile"
            )

        profile = profile_response.data[0]

        return UserResponse(
            id=profile["id"],
            email=profile["email"],
            is_admin=profile["is_admin"],
            created_at=profile["created_at"]
        )

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to create user: {str(e)}"
        )


@router.get("/users", response_model=list[UserResponse])
async def list_users(
    admin: User = Depends(get_admin_user)
) -> list[UserResponse]:
    """List all users (admin only)."""
    supabase_admin = get_supabase_admin_client()

    try:
        response = supabase_admin.table("user_profiles").select("*").order("created_at", desc=True).execute()

        return [
            UserResponse(
                id=user["id"],
                email=user["email"],
                is_admin=user["is_admin"],
                created_at=user["created_at"]
            )
            for user in response.data
        ]
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to list users: {str(e)}"
        )
```

#### 2.3: Create Supabase Admin client helper
```python
# backend/app/db/supabase.py (add to existing file)
from supabase import create_client, Client
from app.config import get_settings

_admin_client: Client | None = None

def get_supabase_admin_client() -> Client:
    """Get Supabase client with service_role key for admin operations."""
    global _admin_client
    settings = get_settings()

    if _admin_client is None:
        _admin_client = create_client(
            settings.supabase_url,
            settings.supabase_service_role_key
        )

    return _admin_client
```

#### 2.4: Update config to include service_role_key
```python
# backend/app/config.py (add field)
class Settings(BaseSettings):
    # ... existing fields ...
    supabase_service_role_key: str

    class Config:
        env_file = ".env"
```

#### 2.5: Include admin router in main.py
```python
# backend/app/main.py
from app.routers import admin  # Add import

app.include_router(admin.router)  # Add after other routers
```

**Validation:**
```bash
# Test create user (as admin)
curl -X POST http://localhost:8000/admin/users \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{"email": "newuser@example.com", "password": "password123", "is_admin": false}'

# Expected: 201 Created with user data

# Test list users
curl http://localhost:8000/admin/users \
  -H "Authorization: Bearer <admin-token>"

# Expected: 200 OK with array of users

# Test access denied (non-admin)
curl -X POST http://localhost:8000/admin/users \
  -H "Authorization: Bearer <non-admin-token>" \
  -H "Content-Type: application/json" \
  -d '{"email": "test@test.com", "password": "password123"}'

# Expected: 403 Forbidden
```

### Phase 3: Frontend - Remove Sign-Up from AuthForm
**Files:** `frontend/src/components/auth/AuthForm.tsx`

Remove the sign-up toggle and form, showing only sign-in:

```tsx
import { useState } from 'react'
import { useAuth } from '@/hooks/useAuth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

export function AuthForm() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  const { signIn } = useAuth()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)
    setLoading(true)

    try {
      await signIn(email, password)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="flex min-h-screen items-center justify-center p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>Sign In</CardTitle>
          <CardDescription>
            Enter your credentials to access your account
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <label htmlFor="email" className="text-sm font-medium">
                Email
              </label>
              <Input
                id="email"
                type="email"
                placeholder="you@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
              />
            </div>
            <div className="space-y-2">
              <label htmlFor="password" className="text-sm font-medium">
                Password
              </label>
              <Input
                id="password"
                type="password"
                placeholder="Your password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                minLength={6}
              />
            </div>

            {error && (
              <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
                {error}
              </div>
            )}

            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? 'Loading...' : 'Sign In'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

**Validation:**
- Visit http://localhost:5173
- Should only see "Sign In" form, no toggle to sign up
- Sign in with test credentials should work

### Phase 4: Frontend - Admin User Management Page
**Files:**
- `frontend/src/pages/AdminPage.tsx` (new)
- `frontend/src/App.tsx` (update routing)

#### 4.1: Create AdminPage component
```tsx
// frontend/src/pages/AdminPage.tsx
import { useState, useEffect } from 'react'
import { useAuth } from '@/hooks/useAuth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

interface User {
  id: string
  email: string
  is_admin: boolean
  created_at: string
}

export function AdminPage() {
  const { user, getAccessToken } = useAuth()
  const [users, setUsers] = useState<User[]>([])
  const [loading, setLoading] = useState(true)
  const [creating, setCreating] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Form state
  const [newEmail, setNewEmail] = useState('')
  const [newPassword, setNewPassword] = useState('')
  const [isAdmin, setIsAdmin] = useState(false)

  useEffect(() => {
    loadUsers()
  }, [])

  const loadUsers = async () => {
    setLoading(true)
    setError(null)

    try {
      const token = await getAccessToken()
      const response = await fetch('http://localhost:8000/admin/users', {
        headers: { Authorization: `Bearer ${token}` }
      })

      if (!response.ok) {
        throw new Error('Failed to load users')
      }

      const data = await response.json()
      setUsers(data)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load users')
    } finally {
      setLoading(false)
    }
  }

  const handleCreateUser = async (e: React.FormEvent) => {
    e.preventDefault()
    setCreating(true)
    setError(null)

    try {
      const token = await getAccessToken()
      const response = await fetch('http://localhost:8000/admin/users', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email: newEmail,
          password: newPassword,
          is_admin: isAdmin
        })
      })

      if (!response.ok) {
        const errorData = await response.json()
        throw new Error(errorData.detail || 'Failed to create user')
      }

      // Reset form
      setNewEmail('')
      setNewPassword('')
      setIsAdmin(false)

      // Reload users list
      await loadUsers()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to create user')
    } finally {
      setCreating(false)
    }
  }

  if (!user?.is_admin) {
    return (
      <div className="flex min-h-screen items-center justify-center p-4">
        <Card className="w-full max-w-md">
          <CardHeader>
            <CardTitle>Access Denied</CardTitle>
            <CardDescription>You need admin access to view this page</CardDescription>
          </CardHeader>
        </Card>
      </div>
    )
  }

  return (
    <div className="container mx-auto max-w-4xl p-4 space-y-6">
      <h1 className="text-3xl font-bold">User Management</h1>

      {/* Create User Form */}
      <Card>
        <CardHeader>
          <CardTitle>Create New User</CardTitle>
          <CardDescription>Add a new user to the system</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleCreateUser} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <label htmlFor="new-email" className="text-sm font-medium">
                  Email
                </label>
                <Input
                  id="new-email"
                  type="email"
                  value={newEmail}
                  onChange={(e) => setNewEmail(e.target.value)}
                  required
                />
              </div>
              <div className="space-y-2">
                <label htmlFor="new-password" className="text-sm font-medium">
                  Password
                </label>
                <Input
                  id="new-password"
                  type="password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  required
                  minLength={6}
                />
              </div>
            </div>

            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="is-admin"
                checked={isAdmin}
                onChange={(e) => setIsAdmin(e.target.checked)}
                className="h-4 w-4"
              />
              <label htmlFor="is-admin" className="text-sm font-medium">
                Admin privileges
              </label>
            </div>

            {error && (
              <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
                {error}
              </div>
            )}

            <Button type="submit" disabled={creating}>
              {creating ? 'Creating...' : 'Create User'}
            </Button>
          </form>
        </CardContent>
      </Card>

      {/* Users List */}
      <Card>
        <CardHeader>
          <CardTitle>All Users</CardTitle>
          <CardDescription>Manage existing users</CardDescription>
        </CardHeader>
        <CardContent>
          {loading ? (
            <p className="text-sm text-muted-foreground">Loading users...</p>
          ) : users.length === 0 ? (
            <p className="text-sm text-muted-foreground">No users found</p>
          ) : (
            <div className="space-y-2">
              {users.map((u) => (
                <div
                  key={u.id}
                  className="flex items-center justify-between border rounded-lg p-3"
                >
                  <div>
                    <p className="font-medium">{u.email}</p>
                    <p className="text-sm text-muted-foreground">
                      Created: {new Date(u.created_at).toLocaleDateString()}
                    </p>
                  </div>
                  <div className="flex items-center gap-2">
                    {u.is_admin && (
                      <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                        Admin
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

#### 4.2: Update App.tsx to include admin route
```tsx
// Add import
import { AdminPage } from '@/pages/AdminPage'

// Add route in the authenticated section
{user && (
  <>
    <Route path="/" element={<ChatPage />} />
    <Route path="/documents" element={<DocumentsPage />} />
    <Route path="/admin" element={<AdminPage />} />  {/* Add this */}
  </>
)}
```

#### 4.3: Add admin link to UserMenu (optional)
```tsx
// frontend/src/components/UserMenu.tsx
// Add admin link if user is admin
{user?.is_admin && (
  <button
    onClick={() => navigate('/admin')}
    className="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100"
  >
    User Management
  </button>
)}
```

**Validation:**
- Sign in as admin (creator@rag.com)
- Navigate to http://localhost:5173/admin
- Should see create user form and user list
- Create a new user, verify it appears in the list
- Sign out and sign in with new user credentials

### Phase 5: Environment Configuration
**Files:**
- `backend/.env` (update)
- `README.md` or setup docs (update)

Add SUPABASE_SERVICE_ROLE_KEY to backend/.env:
```
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

Get the service role key from Supabase dashboard:
1. Go to Project Settings → API
2. Copy the `service_role` key (not anon key!)
3. Add to .env file

**Security Note:** Service role key bypasses RLS - only use in trusted backend code, never expose to frontend!

**Validation:**
```bash
# Verify env var is loaded
cd backend
source venv/Scripts/activate  # or venv/bin/activate on Unix
python -c "from app.config import get_settings; print(get_settings().supabase_service_role_key[:10])"
# Should print first 10 chars of service role key
```

## Validation Checklist

### Database ✅
- [ ] Migration applied successfully
- [ ] user_profiles table exists with correct schema
- [ ] RLS policies are active
- [ ] Admin user profile exists (creator@rag.com with is_admin=true)

### Backend API ✅
- [ ] POST /admin/users creates a new user (admin only)
- [ ] GET /admin/users lists all users (admin only)
- [ ] Non-admin gets 403 Forbidden on admin endpoints
- [ ] get_current_user queries user_profiles for admin status
- [ ] Service role key configured in .env

### Frontend ✅
- [ ] AuthForm shows only sign-in (no sign-up toggle)
- [ ] Admin page accessible at /admin
- [ ] Admin page shows create user form
- [ ] Admin page shows list of all users
- [ ] Non-admin users get "Access Denied" on admin page
- [ ] Admin link in UserMenu (if user is admin)

### End-to-End ✅
- [ ] Admin can create a new user via UI
- [ ] Newly created user can sign in immediately
- [ ] New user cannot access /admin page
- [ ] New user can access chat and documents pages
- [ ] Users are isolated (can only see their own threads/documents)

## Migration Path for Existing Users

If you have existing users in auth.users:
1. Apply the migration (includes trigger for new users)
2. Manually backfill existing users:
   ```sql
   INSERT INTO user_profiles (id, email, is_admin)
   SELECT id, email, false FROM auth.users
   ON CONFLICT (id) DO NOTHING;
   ```
3. Set admin flag for specific users:
   ```sql
   UPDATE user_profiles SET is_admin = true WHERE email = 'creator@rag.com';
   ```

## Notes
- Public sign-up is completely disabled - only admins can create users
- Email confirmation is auto-confirmed for admin-created users
- Service role key has full database access - keep it secret!
- Consider adding user deletion/deactivation in future iterations
- Consider password reset flow for users (currently not implemented)
